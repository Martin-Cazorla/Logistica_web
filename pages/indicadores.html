<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores de Rendimiento</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1>DASHBOARD DE RENDIMIENTO</h1>

    <div class="resumen-container">
        <div class="filtro-grupo-dashboard">
            <label>FILTRAR POR DÍA:</label>
            <input type="date" id="filtro-fecha-dashboard" class="input-calendario">
            <button class="btn-excel" id="btn-aplicar-filtro">FILTRAR</button>
            <button class="btn-historial" id="btn-quitar-filtro">VER TODO</button>
        </div>
    </div>

    <div class="resumen-container">
        <div class="kpi-card border-blue">
            <span class="kpi-label">UNIDADES EN PERIODO</span>
            <span id="kpi-unidades" class="kpi-value">0</span>
        </div>

        <div class="kpi-card border-green">
            <span class="kpi-label">PRODUCTIVIDAD x UNIDAD</span>
            <span id="kpi-productividad" class="kpi-value">0.00</span>
        </div>
        
        <div class="kpi-card border-yellow">
            <span class="kpi-label">RATIO DE EXTRAS</span>
            <span id="kpi-extras" class="kpi-value">0%</span>
        </div>

        <div class="acciones-botones">

            <a href="../index.html" class="btn-historial">VOLVER AL PANEL</a>

        </div>
    </div>

    <div class="resumen-container dashboard-grafico">
        <canvas id="graficoVueltas" width="400" height="150"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa1n9yQJ33viJ_3P-99yuL4-fzQFzLPis",
            authDomain: "logistica-envios-44bf6.firebaseapp.com",
            projectId: "logistica-envios-44bf6",
            storageBucket: "logistica-envios-44bf6.firebasestorage.app",
            messagingSenderId: "611013572218",
            appId: "1:611013572218:web:beb687be674a65ceafadc3",
            measurementId: "G-V14SKXYCJ5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let datosGlobales = [];
        let chartInstance = null;

        async function obtenerDatos() {
            const q = query(collection(db, "historialLogistica"), orderBy("fecha", "asc"));
            const querySnapshot = await getDocs(q);
            datosGlobales = [];
            querySnapshot.forEach(doc => datosGlobales.push(doc.data()));
            
            actualizarDashboard(datosGlobales);
        }

function actualizarDashboard(datos) {
            if (datos.length === 0) {
                document.getElementById('kpi-unidades').innerText = "0";
                document.getElementById('kpi-productividad').innerText = "0.00";
                document.getElementById('kpi-extras').innerText = "0%";
                return;
            }

            // KPIs
            const totalUnidades = datos.length;
            const totalVueltas = datos.reduce((sum, reg) => sum + Number(reg.vueltas), 0);

            const totalExtras = datos.filter(reg => Number(reg.extra) > 0).length;

            document.getElementById('kpi-unidades').innerText = totalUnidades;
            document.getElementById('kpi-productividad').innerText = (totalVueltas / totalUnidades).toFixed(2);
            document.getElementById('kpi-extras').innerText = ((totalExtras / totalUnidades) * 100).toFixed(0) + "%";

            // PROCESAMIENTO PARA GRÁFICO 
            const statsPorDia = {};
            datos.forEach(reg => {
                if (!statsPorDia[reg.fecha]) {
                    statsPorDia[reg.fecha] = { vueltas: 0, unidades: 0 };
                }
                statsPorDia[reg.fecha].vueltas += Number(reg.vueltas);
                statsPorDia[reg.fecha].unidades += 1; 
            });

            const fechas = Object.keys(statsPorDia);
            const dataVueltas = fechas.map(f => statsPorDia[f].vueltas);
            const dataUnidades = fechas.map(f => statsPorDia[f].unidades);

            renderizarGrafico(fechas, dataVueltas, dataUnidades);
        }

        function renderizarGrafico(fechas, vueltas, unidades) {
            const ctx = document.getElementById('graficoVueltas').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fechas,
                    datasets: [
                        {
                            label: 'Vueltas Totales',
                            data: vueltas,
                            borderColor: '#2d7a44', 
                            backgroundColor: 'rgba(45, 122, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y' 
                        },
                        {
                            label: 'Unidades Presentes',
                            data: unidades,
                            borderColor: '#007bff', 
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1' 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Vueltas' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Unidades' },
                            beginAtZero: true,
                            grid: { drawOnChartArea: false } // No ensucia el gráfico
                        }
                    }
                }
            });
        }
        // Eventos de Filtros
        document.getElementById('btn-aplicar-filtro').addEventListener('click', () => {
            const fechaFiltro = document.getElementById('filtro-fecha-dashboard').value;
            if (!fechaFiltro) return;
            const filtrados = datosGlobales.filter(d => d.fecha === fechaFiltro);
            actualizarDashboard(filtrados);
        });

        document.getElementById('btn-quitar-filtro').addEventListener('click', () => {
            document.getElementById('filtro-fecha-dashboard').value = "";
            actualizarDashboard(datosGlobales);
        });

        obtenerDatos();
    </script>
</body>
</html>